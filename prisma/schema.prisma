generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 系统用户表
model User {
  id               String            @id @default(uuid()) // 主键，自动生成 UUID
  // ...其他字段
}

// 工作空间表
model Workspace {
  id            String         @id @default(uuid())        // 工作空间唯一标识
  name          String                                     // 工作空间名称
  // ... 其他工作空间字段
}

// 支付用户表
model PaymentUser {
  id               String            @id @default(uuid())  // 支付用户唯一标识
  userId           String                                  // 关联的系统用户ID
  email            String            @unique               // 支付用户邮箱，用于支付平台识别
  paymentPlatform  PaymentPlatform   @default(STRIPE)      // 支付平台类型
  customerId       String?           @unique               // 支付平台的客户ID
  payments         Payment[]                               // 用户的所有支付记录
  creditRecords    CreditRecord[]                          // 用户发起的充值记录
  createdAt        DateTime          @default(now())       // 记录创建时间
  updatedAt        DateTime          @updatedAt            // 记录更新时间
}

// 支付记录表
model Payment {
  id               String            @id @default(uuid())  // 支付记录唯一标识
  amount           Float                                   // 支付金额
  currency         String            @default("usd")       // 货币类型，默认美元
  status           PaymentStatus                           // 支付状态
  paymentPlatform  PaymentPlatform   @default(STRIPE)      // 支付平台类型
  paymentId        String            @unique               // 支付平台的支付交易ID
  paymentUserId    String                                  // 关联的支付用户ID
  paymentUser      PaymentUser       @relation(fields: [paymentUserId], references: [id]) // 关联的支付用户
  createdAt        DateTime          @default(now())       // 记录创建时间
  updatedAt        DateTime          @updatedAt            // 记录更新时间
}

// 订阅表
model Subscription {
  id               String             @id @default(uuid())  // 订阅记录唯一标识
  paymentPlatform  PaymentPlatform    @default(STRIPE)      // 支付平台类型
  subscriptionId   String             @unique               // 支付平台的订阅ID
  status           SubscriptionStatus                       // 订阅状态
  workspaceId      String             @unique               // 关联的工作空间ID
  workspace        Workspace          @relation(fields: [workspaceId], references: [id]) // 关联的工作空间
  plan             PlanType                                 // 订阅计划类型
  startDate        DateTime                                 // 当前订阅周期的开始时间
  endDate          DateTime                                 // 当前订阅周期的结束时间
  createdAt        DateTime           @default(now())       // 记录创建时间
  updatedAt        DateTime           @updatedAt            // 记录更新时间
}

// 功能使用情况表
model FeatureUsage {
  id             String        @id @default(uuid())       // 使用记录唯一标识
  workspaceId    String                                   // 关联的工作空间ID
  workspace      Workspace     @relation(fields: [workspaceId], references: [id]) // 关联的工作空间
  featureCode    String                                   // 功能 code
  used           Float                                    // 功能的使用量
  createdAt      DateTime      @default(now())            // 记录创建时间
  updatedAt      DateTime      @updatedAt                 // 记录更新时间

  @@unique([workspaceId, featureCode])                    // 确保每个工作空间的每个功能只有一条使用记录
}

// 支付状态枚举
enum PaymentStatus {
  PENDING            // 支付待处理
  SUCCEEDED          // 支付成功
  FAILED             // 支付失败
}

// 订阅状态枚举
enum SubscriptionStatus {
  ACTIVE          // 订阅激活中
  CANCELED        // 订阅已取消
  PAST_DUE        // 订阅已逾期
  UNPAID          // 订阅未支付
  TRIAL           // 试用期
}

// 订阅计划类型枚举
enum PlanType {
  FREE                // 免费版计划
  BASIC               // 基础版计划
  PRO                 // 专业版计划
  ENTERPRISE          // 企业版计划
}

// 支付平台类型枚举
enum PaymentPlatform {
  STRIPE              // Stripe支付平台
  // ...其他支付平台
}

// 充值余额表
model Credit {
  id            String        @id @default(uuid())         // 记录唯一标识
  workspaceId   String        @unique                      // 关联的工作空间ID
  workspace     Workspace     @relation(fields: [workspaceId], references: [id]) // 关联的工作空间
  balance       Float         @default(0)                  // 当前余额
  total         Float         @default(0)                  // 历史总充值量
  totalUsage    Float         @default(0)                  // 历史总使用量
  createdAt     DateTime      @default(now())              // 记录创建时间
  updatedAt     DateTime      @updatedAt                   // 记录更新时间
}

// 充值记录表
model CreditRecord {
  id            String        @id @default(uuid())       // 充值记录唯一标识
  amount        Float                                    // 充值金额
  type          CreditType    @default(PURCHASE)         // 充值记录类型
  workspaceId   String                                   // 关联的工作空间ID
  workspace     Workspace     @relation(fields: [workspaceId], references: [id]) // 关联的工作空间
  paymentUserId String                                   // 购买充值的支付用户ID
  paymentUser   PaymentUser   @relation(fields: [paymentUserId], references: [id]) // 购买充值的支付用户
  paymentId     String?       @unique                    // 关联的支付记录ID
  payment       Payment?      @relation(fields: [paymentId], references: [paymentId]) // 关联的支付记录
  description   String?                                  // 充值变动说明
  createdAt     DateTime      @default(now())            // 记录创建时间
  updatedAt     DateTime      @updatedAt                 // 记录更新时间
}

// 充值使用记录表
model CreditUsage {
  id            String        @id @default(uuid())        // 使用记录唯一标识
  workspaceId   String                                    // 关联的工作空间ID
  workspace     Workspace     @relation(fields: [workspaceId], references: [id]) // 关联的工作空间
  featureCode   String                                    // 功能 code
  amount        Float                                     // 消费金额
  description   String                                    // 使用描述
  status        UsageStatus   @default(SUCCEEDED)         // 使用状态
  createdAt     DateTime      @default(now())             // 记录创建时间
  updatedAt     DateTime      @updatedAt                  // 记录更新时间
}

// 新增使用状态枚举
enum UsageStatus {
  SUCCEEDED          // 扣费成功
  FAILED             // 扣费失败（余额不足）
  REFUNDED           // 已退还
}

// 新增充值记录类型枚举
enum CreditType {
  PURCHASE            // 购买充值
  // ...其他充值类型，优惠卷什么的
}

// AI 使用记录表
model AIUsage {
  id            String        @id @default(uuid())        // 使用记录唯一标识
  workspaceId   String                                    // 关联的工作空间ID
  workspace     Workspace     @relation(fields: [workspaceId], references: [id]) // 关联的工作空间
  pageId        String                                    // 页面ID
  type          AIUsageType                               // AI 使用类型
  points        Int                                       // 消耗的点数
  freePoints    Int                                       // 免费点数
  description   String?                                   // 使用描述
  createdAt     DateTime      @default(now())             // 记录创建时间
  updatedAt     DateTime      @updatedAt                  // 记录更新时间

  @@unique([workspaceId, pageId])                         // 确保每个工作空间的每个页面只有一条使用记录
}

// AI 使用类型枚举
enum AIUsageType {
  TEXT_CHAT           // 文字对话
  IMAGE_GENERATION    // 图片生成
}